# 技术实现指南

## 📋 文档概述

**文档用途**: 里程碑1-1主窗口和组件实现的技术方案和代码结构  
**技术栈**: WPF + .NET 8.0 + MVVM模式  
**设计模式**: 分层架构 + 依赖注入 + 命令模式  

## 🏗️ 项目结构设计

### 文件夹结构
```
AINovelAgent/
├── Models/                     # 数据模型层
│   ├── Base/                  # 基础模型
│   ├── Configuration/         # 配置模型
│   └── Project/               # 项目模型
├── Services/                  # 业务服务层
│   ├── Interfaces/            # 服务接口
│   ├── Configuration/         # 配置服务
│   ├── Logging/               # 日志服务
│   └── File/                  # 文件服务
├── ViewModels/                # 视图模型层
│   ├── Base/                  # 基础视图模型
│   ├── Main/                  # 主窗口视图模型
│   └── Dialogs/               # 对话框视图模型
├── Views/                     # 视图层
│   ├── Base/                  # 基础视图
│   ├── Main/                  # 主窗口视图
│   ├── Dialogs/               # 对话框视图
│   └── Controls/              # 自定义控件
├── Utils/                     # 工具类
│   ├── Commands/              # 命令实现
│   ├── Converters/            # 值转换器
│   └── Extensions/            # 扩展方法
├── Resources/                 # 资源文件
│   ├── Styles/                # 样式资源
│   ├── Themes/                # 主题资源
│   └── Images/                # 图像资源
└── App.xaml                   # 应用程序入口
```

## 🔧 核心实现方案

### 1. 主窗口布局实现

#### XAML结构设计
```xml
<Window x:Class="AINovelAgent.Views.Main.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="AI小说写作助手" Height="800" Width="1200"
        WindowStartupLocation="CenterScreen">
    
    <DockPanel>
        <!-- 菜单栏 -->
        <Menu DockPanel.Dock="Top" Style="{StaticResource MainMenuStyle}">
            <!-- 菜单项内容 -->
        </Menu>
        
        <!-- 工具栏 -->
        <ToolBar DockPanel.Dock="Top" Style="{StaticResource MainToolBarStyle}">
            <!-- 工具栏按钮 -->
        </ToolBar>
        
        <!-- 主内容区域 -->
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250" MinWidth="200" MaxWidth="400"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            
            <!-- 侧边栏 -->
            <Border Grid.Column="0" Style="{StaticResource SideBarStyle}">
                <!-- 侧边栏内容 -->
            </Border>
            
            <!-- 工作区域 -->
            <Border Grid.Column="1" Style="{StaticResource WorkAreaStyle}">
                <!-- 工作区域内容 -->
            </Border>
        </Grid>
        
        <!-- 状态栏 -->
        <StatusBar DockPanel.Dock="Bottom" Style="{StaticResource MainStatusBarStyle}">
            <!-- 状态栏内容 -->
        </StatusBar>
    </DockPanel>
</Window>
```

#### 代码后台实现
```csharp
namespace AINovelAgent.Views.Main
{
    public partial class MainWindow : Window
    {
        private readonly MainWindowViewModel _viewModel;
        
        public MainWindow()
        {
            InitializeComponent();
            _viewModel = new MainWindowViewModel();
            DataContext = _viewModel;
            
            // 注册事件处理
            RegisterEventHandlers();
        }
        
        private void RegisterEventHandlers()
        {
            // 窗口大小改变事件
            SizeChanged += MainWindow_SizeChanged;
            
            // 窗口关闭事件
            Closing += MainWindow_Closing;
        }
        
        private void MainWindow_SizeChanged(object sender, SizeChangedEventArgs e)
        {
            // 响应式布局处理
            _viewModel.HandleWindowSizeChanged(e.NewSize);
        }
        
        private void MainWindow_Closing(object sender, CancelEventArgs e)
        {
            // 保存窗口状态
            _viewModel.SaveWindowState();
        }
    }
}
```

### 2. MVVM架构实现

#### 基础视图模型
```csharp
namespace AINovelAgent.ViewModels.Base
{
    public abstract class BaseViewModel : INotifyPropertyChanged, IDisposable
    {
        private bool _disposed = false;
        
        public event PropertyChangedEventHandler PropertyChanged;
        
        protected virtual void OnPropertyChanged([CallerMemberName] string propertyName = null)
        {
            PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
        }
        
        protected virtual bool SetProperty<T>(ref T field, T value, [CallerMemberName] string propertyName = null)
        {
            if (EqualityComparer<T>.Default.Equals(field, value)) return false;
            field = value;
            OnPropertyChanged(propertyName);
            return true;
        }
        
        public virtual void Dispose()
        {
            if (!_disposed)
            {
                _disposed = true;
                Dispose(true);
                GC.SuppressFinalize(this);
            }
        }
        
        protected virtual void Dispose(bool disposing)
        {
            // 子类重写此方法进行资源清理
        }
    }
}
```

#### 主窗口视图模型
```csharp
namespace AINovelAgent.ViewModels.Main
{
    public class MainWindowViewModel : BaseViewModel
    {
        private readonly IConfigurationService _configService;
        private readonly ILoggingService _loggingService;
        
        // 属性
        private bool _isSideBarVisible = true;
        private bool _isToolBarVisible = true;
        private bool _isStatusBarVisible = true;
        private string _statusMessage = "就绪";
        private double _progressValue = 0;
        private bool _isProgressVisible = false;
        
        // 命令
        public ICommand NewProjectCommand { get; }
        public ICommand OpenFileCommand { get; }
        public ICommand SaveCommand { get; }
        public ICommand ToggleSideBarCommand { get; }
        public ICommand ToggleToolBarCommand { get; }
        public ICommand ToggleStatusBarCommand { get; }
        public ICommand SettingsCommand { get; }
        public ICommand HelpCommand { get; }
        
        public MainWindowViewModel(
            IConfigurationService configService,
            ILoggingService loggingService)
        {
            _configService = configService;
            _loggingService = loggingService;
            
            // 初始化命令
            InitializeCommands();
            
            // 加载配置
            LoadConfiguration();
        }
        
        private void InitializeCommands()
        {
            NewProjectCommand = new RelayCommand(ExecuteNewProject, CanExecuteNewProject);
            OpenFileCommand = new RelayCommand(ExecuteOpenFile, CanExecuteOpenFile);
            SaveCommand = new RelayCommand(ExecuteSave, CanExecuteSave);
            ToggleSideBarCommand = new RelayCommand(ExecuteToggleSideBar);
            ToggleToolBarCommand = new RelayCommand(ExecuteToggleToolBar);
            ToggleStatusBarCommand = new RelayCommand(ExecuteToggleStatusBar);
            SettingsCommand = new RelayCommand(ExecuteSettings);
            HelpCommand = new RelayCommand(ExecuteHelp);
        }
        
        // 属性实现
        public bool IsSideBarVisible
        {
            get => _isSideBarVisible;
            set => SetProperty(ref _isSideBarVisible, value);
        }
        
        public bool IsToolBarVisible
        {
            get => _isToolBarVisible;
            set => SetProperty(ref _isToolBarVisible, value);
        }
        
        public bool IsStatusBarVisible
        {
            get => _isStatusBarVisible;
            set => SetProperty(ref _isStatusBarVisible, value);
        }
        
        public string StatusMessage
        {
            get => _statusMessage;
            set => SetProperty(ref _statusMessage, value);
        }
        
        public double ProgressValue
        {
            get => _progressValue;
            set => SetProperty(ref _progressValue, value);
        }
        
        public bool IsProgressVisible
        {
            get => _isProgressVisible;
            set => SetProperty(ref _isProgressVisible, value);
        }
        
        // 命令执行方法
        private void ExecuteNewProject()
        {
            try
            {
                _loggingService.LogInformation("执行新建项目命令");
                // 实现新建项目逻辑
                StatusMessage = "正在创建新项目...";
                // TODO: 实现新建项目功能
            }
            catch (Exception ex)
            {
                _loggingService.LogError(ex, "新建项目失败");
                StatusMessage = "新建项目失败";
            }
        }
        
        private bool CanExecuteNewProject()
        {
            return true; // 根据实际业务逻辑判断
        }
        
        private void ExecuteOpenFile()
        {
            try
            {
                _loggingService.LogInformation("执行打开文件命令");
                // 实现打开文件逻辑
                StatusMessage = "正在打开文件...";
                // TODO: 实现打开文件功能
            }
            catch (Exception ex)
            {
                _loggingService.LogError(ex, "打开文件失败");
                StatusMessage = "打开文件失败";
            }
        }
        
        private bool CanExecuteOpenFile()
        {
            return true; // 根据实际业务逻辑判断
        }
        
        private void ExecuteSave()
        {
            try
            {
                _loggingService.LogInformation("执行保存命令");
                // 实现保存逻辑
                StatusMessage = "正在保存...";
                // TODO: 实现保存功能
            }
            catch (Exception ex)
            {
                _loggingService.LogError(ex, "保存失败");
                StatusMessage = "保存失败";
            }
        }
        
        private bool CanExecuteSave()
        {
            return true; // 根据实际业务逻辑判断
        }
        
        private void ExecuteToggleSideBar()
        {
            IsSideBarVisible = !IsSideBarVisible;
            _loggingService.LogInformation($"侧边栏显示状态: {IsSideBarVisible}");
        }
        
        private void ExecuteToggleToolBar()
        {
            IsToolBarVisible = !IsToolBarVisible;
            _loggingService.LogInformation($"工具栏显示状态: {IsToolBarVisible}");
        }
        
        private void ExecuteToggleStatusBar()
        {
            IsStatusBarVisible = !IsStatusBarVisible;
            _loggingService.LogInformation($"状态栏显示状态: {IsStatusBarVisible}");
        }
        
        private void ExecuteSettings()
        {
            try
            {
                _loggingService.LogInformation("打开设置窗口");
                // TODO: 实现设置窗口打开逻辑
                StatusMessage = "正在打开设置...";
            }
            catch (Exception ex)
            {
                _loggingService.LogError(ex, "打开设置窗口失败");
                StatusMessage = "打开设置失败";
            }
        }
        
        private void ExecuteHelp()
        {
            try
            {
                _loggingService.LogInformation("打开帮助窗口");
                // TODO: 实现帮助窗口打开逻辑
                StatusMessage = "正在打开帮助...";
            }
            catch (Exception ex)
            {
                _loggingService.LogError(ex, "打开帮助窗口失败");
                StatusMessage = "打开帮助失败";
            }
        }
        
        // 公共方法
        public void HandleWindowSizeChanged(Size newSize)
        {
            // 根据窗口大小调整布局
            if (newSize.Width < 800)
            {
                IsSideBarVisible = false;
            }
            else if (newSize.Width > 1200)
            {
                IsSideBarVisible = true;
            }
        }
        
        public void SaveWindowState()
        {
            try
            {
                var settings = new Dictionary<string, object>
                {
                    ["IsSideBarVisible"] = IsSideBarVisible,
                    ["IsToolBarVisible"] = IsToolBarVisible,
                    ["IsStatusBarVisible"] = IsStatusBarVisible
                };
                
                _configService.SaveSettings("WindowState", settings);
                _loggingService.LogInformation("窗口状态已保存");
            }
            catch (Exception ex)
            {
                _loggingService.LogError(ex, "保存窗口状态失败");
            }
        }
        
        private void LoadConfiguration()
        {
            try
            {
                var settings = _configService.GetSettings("WindowState");
                if (settings != null)
                {
                    IsSideBarVisible = settings.GetValueOrDefault("IsSideBarVisible", true);
                    IsToolBarVisible = settings.GetValueOrDefault("IsToolBarVisible", true);
                    IsStatusBarVisible = settings.GetValueOrDefault("IsStatusBarVisible", true);
                }
                
                _loggingService.LogInformation("窗口配置已加载");
            }
            catch (Exception ex)
            {
                _loggingService.LogError(ex, "加载窗口配置失败");
            }
        }
    }
}
```

### 3. 样式系统实现

#### 基础样式资源字典
```xml
<!-- Resources/Styles/BaseStyles.xaml -->
<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
    
    <!-- 颜色定义 -->
    <Color x:Key="PrimaryColor">#2196F3</Color>
    <Color x:Key="PrimaryLightColor">#64B5F6</Color>
    <Color x:Key="PrimaryDarkColor">#1976D2</Color>
    <Color x:Key="AccentColor">#FF9800</Color>
    <Color x:Key="SuccessColor">#4CAF50</Color>
    <Color x:Key="WarningColor">#FFC107</Color>
    <Color x:Key="ErrorColor">#F44336</Color>
    <Color x:Key="BackgroundColor">#FAFAFA</Color>
    <Color x:Key="TextColor">#212121</Color>
    
    <!-- 画刷定义 -->
    <SolidColorBrush x:Key="PrimaryBrush" Color="{StaticResource PrimaryColor}"/>
    <SolidColorBrush x:Key="PrimaryLightBrush" Color="{StaticResource PrimaryLightColor}"/>
    <SolidColorBrush x:Key="PrimaryDarkBrush" Color="{StaticResource PrimaryDarkColor}"/>
    <SolidColorBrush x:Key="AccentBrush" Color="{StaticResource AccentColor}"/>
    <SolidColorBrush x:Key="SuccessBrush" Color="{StaticResource SuccessColor}"/>
    <SolidColorBrush x:Key="WarningBrush" Color="{StaticResource WarningColor}"/>
    <SolidColorBrush x:Key="ErrorBrush" Color="{StaticResource ErrorColor}"/>
    <SolidColorBrush x:Key="BackgroundBrush" Color="{StaticResource BackgroundColor}"/>
    <SolidColorBrush x:Key="TextBrush" Color="{StaticResource TextColor}"/>
    
    <!-- 按钮样式 -->
    <Style x:Key="BaseButtonStyle" TargetType="Button">
        <Setter Property="Background" Value="{StaticResource PrimaryBrush}"/>
        <Setter Property="Foreground" Value="White"/>
        <Setter Property="BorderThickness" Value="0"/>
        <Setter Property="Padding" Value="12,8"/>
        <Setter Property="FontFamily" Value="Segoe UI"/>
        <Setter Property="FontSize" Value="12"/>
        <Setter Property="FontWeight" Value="Medium"/>
        <Setter Property="Cursor" Value="Hand"/>
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="Button">
                    <Border Background="{TemplateBinding Background}"
                            CornerRadius="4"
                            Padding="{TemplateBinding Padding}">
                        <ContentPresenter HorizontalAlignment="Center" 
                                        VerticalAlignment="Center"/>
                    </Border>
                    <ControlTemplate.Triggers>
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter Property="Background" Value="{StaticResource PrimaryLightBrush}"/>
                        </Trigger>
                        <Trigger Property="IsPressed" Value="True">
                            <Setter Property="Background" Value="{StaticResource PrimaryDarkBrush}"/>
                        </Trigger>
                        <Trigger Property="IsEnabled" Value="False">
                            <Setter Property="Opacity" Value="0.6"/>
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>
    
    <!-- 菜单样式 -->
    <Style x:Key="MainMenuStyle" TargetType="Menu">
        <Setter Property="Background" Value="#F5F5F5"/>
        <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
        <Setter Property="FontFamily" Value="Segoe UI"/>
        <Setter Property="FontSize" Value="11"/>
    </Style>
    
    <!-- 工具栏样式 -->
    <Style x:Key="MainToolBarStyle" TargetType="ToolBar">
        <Setter Property="Background" Value="#F5F5F5"/>
        <Setter Property="BorderBrush" Value="#E0E0E0"/>
        <Setter Property="BorderThickness" Value="0,0,0,1"/>
    </Style>
    
    <!-- 侧边栏样式 -->
    <Style x:Key="SideBarStyle" TargetType="Border">
        <Setter Property="Background" Value="White"/>
        <Setter Property="BorderBrush" Value="#E0E0E0"/>
        <Setter Property="BorderThickness" Value="0,0,1,0"/>
    </Style>
    
    <!-- 工作区域样式 -->
    <Style x:Key="WorkAreaStyle" TargetType="Border">
        <Setter Property="Background" Value="{StaticResource BackgroundBrush}"/>
    </Style>
    
    <!-- 状态栏样式 -->
    <Style x:Key="MainStatusBarStyle" TargetType="StatusBar">
        <Setter Property="Background" Value="#F5F5F5"/>
        <Setter Property="BorderBrush" Value="#E0E0E0"/>
        <Setter Property="BorderThickness" Value="0,1,0,0"/>
        <Setter Property="FontFamily" Value="Segoe UI"/>
        <Setter Property="FontSize" Value="11"/>
    </Style>
    
</ResourceDictionary>
```

### 4. 服务层实现

#### 配置服务接口
```csharp
namespace AINovelAgent.Services.Interfaces
{
    public interface IConfigurationService
    {
        T GetValue<T>(string key, T defaultValue = default);
        void SetValue<T>(string key, T value);
        Dictionary<string, object> GetSettings(string section);
        void SaveSettings(string section, Dictionary<string, object> settings);
        void LoadConfiguration();
        void SaveConfiguration();
    }
}
```

#### 配置服务实现
```csharp
namespace AINovelAgent.Services.Configuration
{
    public class ConfigurationService : IConfigurationService
    {
        private readonly ILogger<ConfigurationService> _logger;
        private readonly string _configFilePath;
        private IConfiguration _configuration;
        
        public ConfigurationService(ILogger<ConfigurationService> logger)
        {
            _logger = logger;
            _configFilePath = Path.Combine(
                Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
                "AINovelAgent",
                "appsettings.json");
            
            LoadConfiguration();
        }
        
        public T GetValue<T>(string key, T defaultValue = default)
        {
            try
            {
                var value = _configuration[key];
                if (string.IsNullOrEmpty(value))
                    return defaultValue;
                
                return (T)Convert.ChangeType(value, typeof(T));
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "获取配置值失败: {Key}", key);
                return defaultValue;
            }
        }
        
        public void SetValue<T>(string key, T value)
        {
            try
            {
                // 这里需要实现配置值的设置逻辑
                // 可以使用内存配置或者重新加载配置文件
                _logger.LogInformation("设置配置值: {Key} = {Value}", key, value);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "设置配置值失败: {Key}", key);
            }
        }
        
        public Dictionary<string, object> GetSettings(string section)
        {
            try
            {
                var sectionConfig = _configuration.GetSection(section);
                var settings = new Dictionary<string, object>();
                
                foreach (var child in sectionConfig.GetChildren())
                {
                    settings[child.Key] = child.Value;
                }
                
                return settings;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "获取配置节失败: {Section}", section);
                return new Dictionary<string, object>();
            }
        }
        
        public void SaveSettings(string section, Dictionary<string, object> settings)
        {
            try
            {
                // 这里需要实现配置保存逻辑
                // 可以将配置保存到JSON文件或者数据库
                _logger.LogInformation("保存配置节: {Section}", section);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "保存配置节失败: {Section}", section);
            }
        }
        
        public void LoadConfiguration()
        {
            try
            {
                var configBuilder = new ConfigurationBuilder();
                
                if (File.Exists(_configFilePath))
                {
                    configBuilder.AddJsonFile(_configFilePath, optional: false, reloadOnChange: true);
                }
                
                configBuilder.AddEnvironmentVariables();
                configBuilder.AddInMemoryCollection(GetDefaultConfiguration());
                
                _configuration = configBuilder.Build();
                
                _logger.LogInformation("配置已加载");
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "加载配置失败");
                // 使用默认配置
                _configuration = new ConfigurationBuilder()
                    .AddInMemoryCollection(GetDefaultConfiguration())
                    .Build();
            }
        }
        
        public void SaveConfiguration()
        {
            try
            {
                var configDir = Path.GetDirectoryName(_configFilePath);
                if (!Directory.Exists(configDir))
                {
                    Directory.CreateDirectory(configDir);
                }
                
                // 这里需要实现配置保存逻辑
                _logger.LogInformation("配置已保存");
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "保存配置失败");
            }
        }
        
        private Dictionary<string, string> GetDefaultConfiguration()
        {
            return new Dictionary<string, string>
            {
                ["Logging:LogLevel:Default"] = "Information",
                ["Logging:LogLevel:Microsoft"] = "Warning",
                ["App:Name"] = "AI小说写作助手",
                ["App:Version"] = "1.0.0",
                ["AI:DefaultModel"] = "llama2",
                ["AI:ApiEndpoint"] = "http://localhost:11434",
                ["File:SupportedFormats"] = ".txt,.md,.docx,.pdf",
                ["UI:Theme"] = "Light",
                ["UI:Language"] = "zh-CN"
            };
        }
    }
}
```

## 🚀 实现步骤

### 第1步：创建项目结构
1. 创建上述文件夹结构
2. 创建基础类和接口
3. 设置项目引用和依赖

### 第2步：实现基础服务
1. 实现配置服务
2. 实现日志服务
3. 创建服务接口

### 第3步：实现视图模型
1. 创建基础视图模型
2. 实现主窗口视图模型
3. 实现命令绑定

### 第4步：创建XAML界面
1. 创建主窗口XAML
2. 实现基础布局
3. 绑定视图模型

### 第5步：实现样式系统
1. 创建样式资源字典
2. 应用样式到控件
3. 测试视觉效果

### 第6步：功能测试
1. 测试基础功能
2. 测试响应式布局
3. 测试样式效果

## 📝 注意事项

1. **性能优化**: 避免过度复杂的绑定，使用虚拟化列表
2. **内存管理**: 及时释放资源，避免内存泄漏
3. **异常处理**: 所有公共方法都要有适当的异常处理
4. **日志记录**: 关键操作都要记录日志，便于调试
5. **配置管理**: 使用配置文件管理设置，避免硬编码
6. **样式统一**: 保持所有控件的样式风格一致
7. **响应式设计**: 支持不同窗口大小的布局适配
8. **可访问性**: 支持键盘导航和屏幕阅读器
